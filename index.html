<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Compartilhador de Links ‚Äî Contador</title>
  <style>
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;
      --glass:rgba(255,255,255,0.03);--success:#10b981;--danger:#ef4444;
      --warning:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:linear-gradient(180deg,#071023 0%,#071733 100%);
      color:#e6eef8;padding:20px;min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto}
    .header{
      display:flex;align-items:center;justify-content:space-between;
      margin-bottom:24px;flex-wrap:wrap;gap:16px;
    }
    h1{font-size:24px;font-weight:700;margin-bottom:4px}
    .subtitle{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1fr 400px;gap:20px}
    .card{
      background:var(--card);padding:20px;border-radius:16px;
      box-shadow:0 8px 24px rgba(2,6,23,0.7);
      border:1px solid rgba(255,255,255,0.05);
    }
    .btn{
      background:var(--accent);color:#04202b;padding:10px 16px;
      border-radius:10px;border:0;font-weight:700;cursor:pointer;
      transition:all 0.2s;font-size:14px;
    }
    .btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(6,182,212,0.4)}
    .btn:active{transform:translateY(0)}
    .btn-danger{background:var(--danger);color:white}
    .btn-secondary{background:#64748b;color:white}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    
    .input,textarea,select{
      width:100%;padding:12px;border-radius:10px;
      border:1px solid rgba(255,255,255,0.08);
      background:rgba(255,255,255,0.02);color:inherit;
      font-size:14px;transition:all 0.2s;
    }
    .input:focus,textarea:focus{
      outline:none;border-color:var(--accent);
      background:rgba(255,255,255,0.04);
    }
    
    .link-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:16px;border-radius:12px;background:var(--glass);
      margin-bottom:12px;border:1px solid rgba(255,255,255,0.03);
      transition:all 0.2s;
    }
    .link-item:hover{
      background:rgba(255,255,255,0.06);
      border-color:rgba(6,182,212,0.3);
    }
    .link-info{flex:1;min-width:0}
    .link-title{font-weight:600;margin-bottom:4px;font-size:15px}
    .link-desc{color:var(--muted);font-size:13px;margin-bottom:6px}
    .link-meta{
      display:flex;gap:12px;font-size:12px;color:var(--muted);
      flex-wrap:wrap;
    }
    .link-actions{display:flex;gap:8px;flex-shrink:0}
    .link-actions button{padding:8px 12px;font-size:13px}
    
    .badge{
      display:inline-block;padding:4px 10px;border-radius:6px;
      font-size:12px;font-weight:600;
    }
    .badge-info{background:rgba(6,182,212,0.2);color:var(--accent)}
    .badge-success{background:rgba(16,185,129,0.2);color:var(--success)}
    
    .form-group{margin-bottom:16px}
    .form-label{
      display:block;margin-bottom:6px;font-size:13px;
      font-weight:600;color:var(--muted);
    }
    
    .stats{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:12px;margin-bottom:20px;
    }
    .stat-card{
      background:var(--glass);padding:16px;border-radius:12px;
      text-align:center;border:1px solid rgba(255,255,255,0.03);
    }
    .stat-value{font-size:28px;font-weight:700;color:var(--accent)}
    .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
    
    .modal{
      position:fixed;inset:0;display:flex;align-items:center;
      justify-content:center;background:rgba(2,6,23,0.8);
      backdrop-filter:blur(4px);z-index:1000;
    }
    .modal-card{
      background:#021226;padding:24px;border-radius:16px;
      width:90%;max-width:440px;border:1px solid rgba(255,255,255,0.1);
      box-shadow:0 20px 60px rgba(0,0,0,0.5);
    }
    .modal-title{font-size:18px;font-weight:700;margin-bottom:16px}
    .modal-actions{
      display:flex;gap:10px;margin-top:20px;justify-content:flex-end;
    }
    
    .alert{
      padding:12px 16px;border-radius:10px;margin-bottom:16px;
      font-size:14px;border-left:4px solid;
    }
    .alert-info{background:rgba(6,182,212,0.1);border-color:var(--accent);color:#7dd3fc}
    .alert-success{background:rgba(16,185,129,0.1);border-color:var(--success);color:#6ee7b7}
    .alert-warning{background:rgba(245,158,11,0.1);border-color:var(--warning);color:#fcd34d}
    
    .admin-badge{
      display:inline-block;padding:4px 8px;background:var(--accent);
      color:#04202b;border-radius:6px;font-size:11px;
      font-weight:700;margin-left:8px;
    }
    
    .loading{
      display:inline-block;width:16px;height:16px;
      border:2px solid rgba(255,255,255,0.2);
      border-top-color:var(--accent);border-radius:50%;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    
    .empty-state{
      text-align:center;padding:40px 20px;color:var(--muted);
    }
    .empty-state-icon{font-size:48px;margin-bottom:12px;opacity:0.3}
    
    .click-list{max-height:300px;overflow-y:auto}
    .click-item{
      padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);
      font-size:13px;display:flex;justify-content:space-between;
    }
    .click-item:last-child{border-bottom:0}
    
    @media(max-width:980px){
      .grid{grid-template-columns:1fr}
      .header{flex-direction:column;align-items:flex-start}
      .link-item{flex-direction:column;align-items:flex-start;gap:12px}
      .link-actions{width:100%;justify-content:flex-start}
    }
    
    .tooltip{
      position:relative;display:inline-block;cursor:help;
    }
    .tooltip:hover::after{
      content:attr(data-tip);position:absolute;bottom:100%;
      left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,0.9);color:white;
      padding:6px 10px;border-radius:6px;font-size:12px;
      white-space:nowrap;margin-bottom:8px;z-index:100;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>üîó Compartilhador de Links <span id="adminIndicator"></span></h1>
        <div class="subtitle">Sistema inteligente de rastreamento e compartilhamento de links</div>
      </div>
      <div class="card" style="padding:12px 16px;display:flex;gap:10px;align-items:center" id="loginArea">
        <input id="adminPass" class="input" placeholder="Senha admin" type="password" style="width:160px">
        <button id="btnAdminLogin" class="btn">üîê Entrar</button>
      </div>
    </div>

    <!-- Estat√≠sticas -->
    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="totalLinks">0</div>
        <div class="stat-label">Links Ativos</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalClicks">0</div>
        <div class="stat-label">Total de Cliques</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="todayClicks">0</div>
        <div class="stat-label">Hoje</div>
      </div>
    </div>

    <div class="grid">
      <!-- √Årea p√∫blica: lista de links -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="font-size:18px;font-weight:700">üìã Links Dispon√≠veis</h2>
          <button id="refreshBtn" class="btn btn-secondary">üîÑ Atualizar</button>
        </div>

        <div class="alert alert-info">
          üí° <strong>Como funciona:</strong> Clique em qualquer link abaixo. Ser√° solicitado seu email ou CPF antes de abrir (opcional, mas ajuda nas estat√≠sticas).
        </div>

        <div class="form-group">
          <label class="form-label">Identifica√ß√£o R√°pida (opcional)</label>
          <input id="identifyInput" class="input" placeholder="Seu email ou CPF para todos os cliques">
          <div style="font-size:12px;color:var(--muted);margin-top:4px">
            Preencha aqui para n√£o precisar digitar a cada clique
          </div>
        </div>

        <div id="linksList"></div>
      </div>

      <!-- Painel admin -->
      <div>
        <div class="card" id="adminPanel" style="display:none">
          <h2 style="font-size:18px;font-weight:700;margin-bottom:16px">‚öôÔ∏è Painel Admin</h2>

          <div class="form-group">
            <label class="form-label">T√≠tulo do Link *</label>
            <input id="linkTitle" class="input" placeholder="Ex: Formul√°rio de Inscri√ß√£o" maxlength="100">
          </div>

          <div class="form-group">
            <label class="form-label">URL Completa *</label>
            <input id="linkUrl" class="input" placeholder="https://..." type="url">
          </div>

          <div class="form-group">
            <label class="form-label">Descri√ß√£o / Criado por</label>
            <input id="linkCreator" class="input" placeholder="Descri√ß√£o ou nome do criador" maxlength="100">
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="addLinkBtn" class="btn">‚ûï Adicionar Link</button>
            <button id="exportBtn" class="btn btn-secondary">üì• Exportar CSV</button>
          </div>

          <hr style="margin:20px 0;border:0;border-top:1px solid rgba(255,255,255,0.05)">

          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h3 style="font-size:15px;font-weight:700">üìä √öltimos Cliques</h3>
            <button id="logoutBtn" class="btn btn-danger" style="padding:6px 12px;font-size:12px">Sair</button>
          </div>

          <div class="click-list" id="recentClicks">
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>Nenhum clique registrado ainda</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para identifica√ß√£o -->
  <div id="identModal" class="modal" style="display:none">
    <div class="modal-card">
      <div class="modal-title">üîê Identifica√ß√£o Opcional</div>
      <div style="color:var(--muted);font-size:14px;margin-bottom:16px">
        Informe seu email ou CPF para registrarmos este clique (ajuda nas estat√≠sticas).
      </div>

      <div class="form-group">
        <label class="form-label">Email ou CPF</label>
        <input id="modalIdent" class="input" placeholder="usuario@email.com ou 123.456.789-00">
        <div style="font-size:12px;color:var(--muted);margin-top:4px">
          Deixe em branco para continuar an√¥nimo
        </div>
      </div>

      <div class="modal-actions">
        <button id="cancelOpen" class="btn btn-secondary">Cancelar</button>
        <button id="confirmOpen" class="btn">Confirmar e Abrir</button>
      </div>
    </div>
  </div>

  <!-- Modal de confirma√ß√£o de exclus√£o -->
  <div id="deleteModal" class="modal" style="display:none">
    <div class="modal-card">
      <div class="modal-title">‚ö†Ô∏è Confirmar Exclus√£o</div>
      <div style="color:var(--muted);font-size:14px;margin-bottom:16px">
        Tem certeza que deseja excluir este link? Esta a√ß√£o n√£o pode ser desfeita.
      </div>
      <div style="font-weight:600;margin-bottom:16px" id="deleteConfirmText"></div>
      <div class="modal-actions">
        <button id="cancelDelete" class="btn btn-secondary">Cancelar</button>
        <button id="confirmDelete" class="btn btn-danger">Excluir</button>
      </div>
    </div>
  </div>

  <script>
    // ========================================
    // CONFIGURA√á√ïES
    // ========================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxMc1mc9EZD-bB1aGJ8XBpAg0czHdM5WYqwuQrk3aWQhOlvam5sSQAMWc_6mq4aBSHbpA/exec';

    // ========================================
    // UTILIT√ÅRIOS
    // ========================================
    const el = id => document.getElementById(id);
    const isUrl = s => /^https?:\/\/.+/.test(s);
    const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
    const isCPF = s => /^\d{3}\.?\d{3}\.?\d{3}-?\d{2}$/.test(s);
    
    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s || '';
      return div.innerHTML;
    }

    function showToast(msg, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type}`;
      toast.textContent = msg;
      toast.style.position = 'fixed';
      toast.style.top = '20px';
      toast.style.right = '20px';
      toast.style.zIndex = '10000';
      toast.style.maxWidth = '400px';
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // ========================================
    // ESTADO GLOBAL
    // ========================================
    let isAdmin = false;
    let pendingOpen = null;
    let pendingDelete = null;
    let allLinks = [];

    // ========================================
    // CARREGAR LINKS
    // ========================================
    async function carregarLinks() {
      try {
        const r = await fetch(SCRIPT_URL + '?action=getLinks');
        const j = await r.json();
        
        if (!j.ok) {
          showToast('Erro ao carregar links', 'warning');
          return;
        }

        allLinks = j.links || [];
        renderLinks();
        updateStats();
      } catch (err) {
        console.error(err);
        showToast('Erro de conex√£o', 'warning');
      }
    }

    function renderLinks() {
      const list = el('linksList');
      
      if (allLinks.length === 0) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>Nenhum link cadastrado ainda</div>
            ${isAdmin ? '<div style="margin-top:8px;font-size:13px">Use o painel ao lado para adicionar links</div>' : ''}
          </div>
        `;
        return;
      }

      list.innerHTML = '';
      
      allLinks.forEach(l => {
        const div = document.createElement('div');
        div.className = 'link-item';
        
        const actionsHtml = isAdmin 
          ? `<button class="btn btn-danger" onclick="prepareDelete('${escapeHtml(l.id)}', '${escapeHtml(l.title)}')" style="padding:8px 12px;font-size:13px">üóëÔ∏è</button>`
          : '';
        
        div.innerHTML = `
          <div class="link-info">
            <div class="link-title">${escapeHtml(l.title)}</div>
            ${l.desc ? `<div class="link-desc">üìù ${escapeHtml(l.desc)}</div>` : ''}
            <div class="link-meta">
              <span>üìÖ ${new Date(l.createdAt || '').toLocaleDateString('pt-BR') || '-'}</span>
              <span class="badge badge-info">${l.count || 0} cliques</span>
            </div>
          </div>
          <div class="link-actions">
            <button class="btn" onclick="prepareOpen('${encodeURIComponent(l.id)}','${encodeURIComponent(l.url)}')">üöÄ Abrir</button>
            <button class="btn btn-secondary" onclick="copyLink('${encodeURIComponent(l.url)}')">üìã Copiar</button>
            ${actionsHtml}
          </div>
        `;
        
        list.appendChild(div);
      });
    }

    function updateStats() {
      el('totalLinks').textContent = allLinks.length;
      const totalClicks = allLinks.reduce((sum, l) => sum + (l.count || 0), 0);
      el('totalClicks').textContent = totalClicks;
      // Today clicks seria mais complexo, requer dados detalhados
      el('todayClicks').textContent = '-';
    }

    // ========================================
    // ABRIR LINK
    // ========================================
    function prepareOpen(idEnc, urlEnc) {
      pendingOpen = { 
        id: decodeURIComponent(idEnc), 
        url: decodeURIComponent(urlEnc) 
      };
      el('modalIdent').value = el('identifyInput').value || '';
      el('identModal').style.display = 'flex';
    }

    el('cancelOpen').addEventListener('click', () => {
      pendingOpen = null;
      el('identModal').style.display = 'none';
    });

    el('confirmOpen').addEventListener('click', async () => {
      if (!pendingOpen) return;
      
      const ident = el('modalIdent').value.trim();
      
      // Valida√ß√£o b√°sica
      if (ident && !isEmail(ident) && !isCPF(ident)) {
        showToast('Por favor, informe um email ou CPF v√°lido', 'warning');
        return;
      }

      // Registrar clique
      try {
        const url = SCRIPT_URL + 
          '?action=recordClick' +
          '&linkId=' + encodeURIComponent(pendingOpen.id) +
          (ident ? ('&ident=' + encodeURIComponent(ident)) : '');
        
        fetch(url).catch(e => console.warn(e));
      } catch (e) {
        console.warn(e);
      }

      // Abrir link
      window.open(pendingOpen.url, '_blank');
      
      showToast('‚úÖ Link aberto com sucesso!', 'success');
      
      pendingOpen = null;
      el('identModal').style.display = 'none';
      
      setTimeout(carregarLinks, 1000);
    });

    function copyLink(url) {
      const decoded = decodeURIComponent(url);
      navigator.clipboard.writeText(decoded)
        .then(() => showToast('‚úÖ Link copiado!', 'success'))
        .catch(() => showToast('Erro ao copiar', 'warning'));
    }

    // ========================================
    // ADMIN - LOGIN
    // ========================================
    el('btnAdminLogin').addEventListener('click', async () => {
      const pass = el('adminPass').value;
      
      if (!pass) {
        showToast('Digite a senha admin', 'warning');
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'auth', password: pass })
        });
        
        const j = await res.json();
        
        if (j && j.ok) {
          isAdmin = true;
          enableAdmin();
          showToast('‚úÖ Login realizado com sucesso!', 'success');
          carregarRecentClicks();
        } else {
          showToast('‚ùå Senha incorreta', 'warning');
        }
      } catch (e) {
        console.error(e);
        showToast('Erro ao autenticar', 'warning');
      }
    });

    function enableAdmin() {
      el('adminPanel').style.display = 'block';
      el('adminPass').value = '';
      el('loginArea').style.display = 'none';
      el('adminIndicator').innerHTML = '<span class="admin-badge">ADMIN</span>';
      renderLinks(); // Re-render para mostrar bot√µes de exclus√£o
    }

    el('logoutBtn').addEventListener('click', () => {
      isAdmin = false;
      el('adminPanel').style.display = 'none';
      el('loginArea').style.display = 'flex';
      el('adminIndicator').innerHTML = '';
      renderLinks();
      showToast('Sess√£o encerrada', 'info');
    });

    // ========================================
    // ADMIN - ADICIONAR LINK
    // ========================================
    el('addLinkBtn').addEventListener('click', async () => {
      const title = el('linkTitle').value.trim();
      const url = el('linkUrl').value.trim();
      const creator = el('linkCreator').value.trim();

      if (!title || !url) {
        showToast('‚ö†Ô∏è Preencha t√≠tulo e URL', 'warning');
        return;
      }

      if (!isUrl(url)) {
        showToast('‚ö†Ô∏è URL inv√°lida (deve come√ßar com http:// ou https://)', 'warning');
        return;
      }

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'addLink', 
            title, 
            url, 
            desc: creator 
          })
        });

        const j = await res.json();

        if (j && j.ok) {
          el('linkTitle').value = '';
          el('linkUrl').value = '';
          el('linkCreator').value = '';
          
          carregarLinks();
          showToast('‚úÖ Link adicionado com sucesso!', 'success');
        } else {
          showToast('Erro ao adicionar link', 'warning');
        }
      } catch (err) {
        console.error(err);
        showToast('Erro na requisi√ß√£o', 'warning');
      }
    });

    // ========================================
    // ADMIN - DELETAR LINK
    // ========================================
    function prepareDelete(linkId, title) {
      pendingDelete = linkId;
      el('deleteConfirmText').textContent = `"${title}"`;
      el('deleteModal').style.display = 'flex';
    }

    el('cancelDelete').addEventListener('click', () => {
      pendingDelete = null;
      el('deleteModal').style.display = 'none';
    });

    el('confirmDelete').addEventListener('click', async () => {
      if (!pendingDelete) return;

      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            action: 'deleteLink', 
            linkId: pendingDelete 
          })
        });

        const j = await res.json();

        if (j && j.ok) {
          showToast('‚úÖ Link exclu√≠do com sucesso!', 'success');
          carregarLinks();
        } else {
          showToast('Erro ao excluir link', 'warning');
        }
      } catch (err) {
        console.error(err);
        showToast('Erro na requisi√ß√£o', 'warning');
      }

      pendingDelete = null;
      el('deleteModal').style.display = 'none';
    });

    // ========================================
    // ADMIN - CLIQUES RECENTES
    // ========================================
    async function carregarRecentClicks() {
      try {
        const r = await fetch(SCRIPT_URL + '?action=getRecentClicks');
        const j = await r.json();
        
        if (!j.ok) return;

        const elc = el('recentClicks');
        elc.innerHTML = '';

        const items = j.items || [];

        if (items.length === 0) {
          elc.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <div>Nenhum clique registrado ainda</div>
            </div>
          `;
          return;
        }

        items.slice(0, 50).forEach(c => {
          const div = document.createElement('div');
          div.className = 'click-item';
          
          const date = new Date(c.ts || '').toLocaleString('pt-BR') || c.ts;
          const ident = c.ident || 'An√¥nimo';
          
          div.innerHTML = `
            <div>
              <strong>${escapeHtml(c.linkTitle || c.linkId)}</strong>
              <div style="color:var(--muted);font-size:12px">${escapeHtml(ident)}</div>
            </div>
            <div style="text-align:right;font-size:12px;color:var(--muted)">
              ${date}
            </div>
          `;
          
          elc.appendChild(div);
        });
      } catch (e) {
        console.warn(e);
      }
    }

    // ========================================
    // ADMIN - EXPORTAR CSV
    // ========================================
    el('exportBtn').addEventListener('click', async () => {
      try {
        const r = await fetch(SCRIPT_URL + '?action=exportCsv');
        const txt = await r.text();
        
        const blob = new Blob([txt], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `cliques_export_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
        
        showToast('‚úÖ CSV exportado com sucesso!', 'success');
      } catch (e) {
        console.error(e);
        showToast('Erro ao exportar CSV', 'warning');
      }
    });

    // ========================================
    // EVENTOS
    // ========================================
    el('refreshBtn').addEventListener('click', carregarLinks);

    // Enter para login
    el('adminPass').addEventListener('keypress', e => {
      if (e.key === 'Enter') el('btnAdminLogin').click();
    });

    // Enter no modal
    el('modalIdent').addEventListener('keypress', e => {
      if (e.key === 'Enter') el('confirmOpen').click();
    });

    // ========================================
    // INICIALIZA√á√ÉO
    // ========================================
    carregarLinks();
    
    // Atualizar a cada 30 segundos
    setInterval(carregarLinks, 30000);
  </script>
</body>
</html>
